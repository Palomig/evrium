-- ========================================
-- ИНСТРУКЦИЯ: Выполняйте по одному блоку!
-- Копируйте каждый блок отдельно в phpMyAdmin
-- ========================================

-- БЛОК 1: Добавляем teacher_id как NULL
ALTER TABLE `students`
ADD COLUMN `teacher_id` INT NULL AFTER `id`;

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 1, ВЫПОЛНИТЕ БЛОК 2:
-- ========================================

-- БЛОК 2: Заполняем teacher_id для существующих записей
UPDATE `students`
SET `teacher_id` = (SELECT `id` FROM `teachers` WHERE `active` = 1 ORDER BY `id` ASC LIMIT 1)
WHERE `teacher_id` IS NULL;

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 2, ВЫПОЛНИТЕ БЛОК 3:
-- ========================================

-- БЛОК 3: Делаем поле обязательным
ALTER TABLE `students`
MODIFY COLUMN `teacher_id` INT NOT NULL;

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 3, ВЫПОЛНИТЕ БЛОК 4:
-- ========================================

-- БЛОК 4: Добавляем внешний ключ
ALTER TABLE `students`
ADD CONSTRAINT `fk_students_teacher`
    FOREIGN KEY (`teacher_id`)
    REFERENCES `teachers`(`id`)
    ON DELETE CASCADE;

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 4, ВЫПОЛНИТЕ БЛОК 5:
-- ========================================

-- БЛОК 5: Добавляем поле tier
ALTER TABLE `students`
ADD COLUMN `tier` ENUM('S', 'A', 'B', 'C', 'D') DEFAULT 'C' AFTER `class`;

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 5, ВЫПОЛНИТЕ БЛОК 6:
-- ========================================

-- БЛОК 6: Переименовываем parent_phone в parent_name
ALTER TABLE `students`
CHANGE COLUMN `parent_phone` `parent_name` VARCHAR(100) NULL;

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 6, ВЫПОЛНИТЕ БЛОК 7:
-- ========================================

-- БЛОК 7: Добавляем мессенджеры ученика (если их еще нет)
ALTER TABLE `students`
ADD COLUMN `student_telegram` VARCHAR(50) NULL AFTER `tier`,
ADD COLUMN `student_whatsapp` VARCHAR(20) NULL AFTER `student_telegram`;

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 7, ВЫПОЛНИТЕ БЛОК 8:
-- ========================================

-- БЛОК 8: Добавляем индексы
ALTER TABLE `students`
ADD INDEX `idx_teacher_id` (`teacher_id`);

-- ========================================
-- ПОСЛЕ ВЫПОЛНЕНИЯ БЛОКА 8, ВЫПОЛНИТЕ БЛОК 9:
-- ========================================

-- БЛОК 9: Добавляем индекс для tier
ALTER TABLE `students`
ADD INDEX `idx_tier` (`tier`);

-- ========================================
-- ГОТОВО! Все изменения применены.
-- ========================================
